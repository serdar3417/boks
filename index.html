<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vision-Fighter: KARƒ∞YER MODU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #050505;
            color: white;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            touch-action: none;
            /* Prevent scroll on mobile */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: none;
        }

        .input_video {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) scaleX(-1);
            width: 30vw;
            /* Responsive width */
            max-width: 300px;
            height: auto;
            border: 3px solid #ffd700;
            border-radius: 8px;
            opacity: 0.9;
            z-index: 5;
            object-fit: cover;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }



        /* HUD */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .fighter-card {
            width: 30%;
            max-width: 400px;
        }

        .bar-bg {
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border: 2px solid #555;
        }

        .hp-bar {
            height: 100%;
            transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .p-bar {
            background: linear-gradient(90deg, #ff1744, #d50000);
            width: 100%;
            box-shadow: 0 0 15px #ff1744;
            float: right;
            /* Player (Red) on Right */
        }

        .e-bar {
            background: linear-gradient(90deg, #00b0ff, #00e5ff);
            width: 100%;
            box-shadow: 0 0 15px #00e5ff;
            /* Enemy (Blue) on Left */
        }

        .name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px black;
        }

        #game-status-text {
            position: absolute;
            top: 290px;
            width: 100%;
            text-align: center;
            z-index: 15;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 10px #000;
            font-weight: 900;
            letter-spacing: 2px;
        }

        #level-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 20px #ffd700;
            z-index: 20;
            text-transform: uppercase;
        }

        /* SCREENS */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .btn-game {
            padding: 15px 50px;
            font-size: 2rem;
            border-radius: 50px;
            margin: 15px;
            background: transparent;
            color: #ffd700;
            border: 3px solid #ffd700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            min-width: 300px;
        }

        .btn-game:hover {
            background: #ffd700;
            color: #000;
            box-shadow: 0 0 60px #ffd700;
            transform: scale(1.05);
        }

        input[type="text"] {
            font-size: 2rem;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #00e5ff;
            background: #111;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            width: 400px;
            outline: none;
        }

        /* CERTIFICATE */
        #certificate {
            background: #fff;
            color: #000;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 20px solid #ffd700;
            position: relative;
            max-width: 800px;
            box-shadow: 0 0 100px rgba(255, 215, 0, 0.5);
            display: none;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .cert-header {
            font-size: 3rem;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .cert-name {
            font-size: 4rem;
            color: #d50000;
            font-family: 'Brush Script MT', cursive;
            margin: 20px 0;
            border-bottom: 2px solid #000;
            display: inline-block;
            padding: 0 50px;
        }

        .cert-text {
            font-size: 1.5rem;
            margin-bottom: 30px;
            font-style: italic;
        }

        .belt-icon {
            font-size: 5rem;
            margin: 20px 0;
            filter: drop-shadow(0 0 10px gold);
        }

        #error-box {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #b00020;
            color: white;
            padding: 10px;
            display: none;
            z-index: 9999;
            font-family: monospace;
        }

        .tutorial {
            color: #aaa;
            margin-top: 30px;
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <div id="error-box"></div>

    <!-- START SCREEN -->
    <div id="start-screen" class="screen">
        <h1 class="display-1 fw-bold mb-4" style="color: #fff; text-shadow: 0 0 30px #00e5ff;">VISION FIGHTER</h1>
        <h3 class="mb-4 text-info">D√úNYA ≈ûAMPƒ∞YONASI</h3>

        <!-- MOVED ABOUT BUTTON HERE -->
        <button id="btn-about" class="btn-game"
            style="font-size: 1rem; padding: 10px 30px; border-color: #00e5ff; color: #00e5ff; margin-bottom: 20px; position:relative; z-index:200;"
            onclick="document.getElementById('about-modal').style.display='block'; if(typeof GAME!=='undefined') GAME.paused=true;">
            ‚ÑπÔ∏è OYUN HAKKINDA / NASIL OYNANIR
        </button>

        <input type="text" id="player-name-input" placeholder="ADINIZI Gƒ∞Rƒ∞N" maxlength="15">
        <div class="d-flex justify-content-center gap-4">
            <button class="btn-game" onclick="startGameFlow('NORMAL')">KARƒ∞YER MODU ü•ä</button>
            <button class="btn-game" onclick="startGameFlow('WORLD_CLASS')"
                style="border-color:#ff1744; color:#ff1744; box-shadow: 0 0 30px rgba(255, 17, 68, 0.3);">WORLD CLASS
                ‚ò†Ô∏è</button>
            <button class="btn-game" onclick="startGameFlow('TRAINING')"
                style="border-color:#00e676; color:#00e676; box-shadow: 0 0 30px rgba(0, 230, 118, 0.3);">ANTRENMAN
                üèãÔ∏è</button>
        </div>

        <div class="tutorial">
            <div><span style="color:#00e5ff">YUMRUK:</span> Havaya Vur | <span style="color:#00e5ff">APARKAT:</span>
                Alttan Vur</div>
            <div><span style="color:#00e5ff">GARD:</span> Elleri Y√ºze Kapat | <span style="color:#00e5ff">KA√á:</span>
                Dua Et (üôè) | <span style="color:#00e5ff">Gƒ∞T:</span> Kollar X</div>
        </div>
    </div>

    <!-- LEVEL UP / VICTORY SCREEN -->
    <div id="message-screen" class="screen" style="display:none;">
        <h1 id="msg-title" class="display-1 fw-bold mb-3" style="color: #00e676;">KAZANDIN!</h1>
        <h3 id="msg-subtitle" class="mb-5 text-white">SIRADAKƒ∞ RAKƒ∞P BEKLƒ∞YOR...</h3>
        <button id="msg-btn" class="btn-game" onclick="nextLevel()">SIRADAKƒ∞ MA√á >></button>
    </div>

    <!-- CHAMPION SCREEN -->
    <div id="champion-screen" class="screen"
        style="display:none; background: radial-gradient(circle, #333 0%, #000 100%);">
        <div id="certificate">
            <div class="belt-icon">üèÜü•áüëë</div>
            <div class="cert-header">BA≈ûARI BELGESƒ∞</div>
            <div class="cert-text">Bu belge, Vision Fighter ≈ûampiyonasƒ±'nƒ±<br><span id="cert-rank"
                    style="font-weight:bold; color:#d50000;">ORDINARY√úS</span> seviyesinde tamamlayan
            </div>
            <div class="cert-name" id="cert-player-name">ƒ∞sim Soyisim</div>
            <div class="cert-text">tarafƒ±ndan kazanƒ±lmƒ±≈ütƒ±r.</div>
            <h2 id="cert-title" style="color:#bf953f; font-weight:bold;">D√úNYA ≈ûAMPƒ∞YONU</h2>
            <div class="mt-4 text-muted">Vision Fighter Association ¬© 2026</div>
        </div>
        <button class="btn-game mt-5" onclick="location.reload()"> ANA MEN√úYE D√ñN </button>
    </div>

    <div id="game-container">
        <video class="input_video"></video>
        <canvas class="output_canvas"></canvas>

        <div id="hud">
            <div class="fighter-card text-start">
                <div class="name" id="hud-e-name" style="color:#ff1744;">RAKƒ∞P</div>
                <div class="bar-bg">
                    <div class="hp-bar e-bar" id="e-hp"></div>
                </div>
            </div>
            <div class="fighter-card text-end">
                <div class="name" id="hud-p-name" style="color:#00e5ff;">OYUNCU</div>
                <div class="bar-bg">
                    <div class="hp-bar p-bar" id="p-hp"></div>
                </div>
                <!-- NEW BARS for Player -->
                <div style="display:flex; justify-content:flex-end; gap:5px; margin-top:5px;">
                    <div class="bar-bg" style="width:48%; height:15px; border-color: gold;">
                        <div id="p-stamina" style="width:100%; height:100%; background:gold; box-shadow:0 0 5px gold;">
                        </div>
                    </div>
                    <div class="bar-bg" style="width:48%; height:15px; border-color: #00e5ff;">
                        <div id="p-super"
                            style="width:0%; height:100%; background:#00e5ff; box-shadow:0 0 5px #00e5ff;"></div>
                    </div>
                </div>
                <div id="super-text" style="font-size:12px; color:#00e5ff; font-weight:bold; opacity:0;">SUPER HAZIR!
                </div>
            </div>
        </div>
        <div id="game-status-text">HAZIRLAN</div>

        <!-- ROUND TIMER UI - Repositioned (Just below camera) -->
        <div style="position: absolute; top: 210px; width: 100%; text-align: center; z-index: 15;">
            <div
                style="background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 10px; padding: 5px 20px; display: inline-block;">
                <div id="round-disp" style="color: gold; font-size: 20px; font-weight: bold;">RAUND 1</div>
                <div id="timer-disp" style="color: white; font-size: 40px; font-weight: bold;">60</div>
            </div>
        </div>

        <div id="level-indicator">SEVƒ∞YE 1</div>
        <div id="regen-indicator">‚ù§Ô∏è ƒ∞Yƒ∞LE≈ûƒ∞YOR...</div>



        <!-- START MATCH OVERLAY -->
        <div id="start-overlay"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; display: none; justify-content: center; align-items: center;">
            <button class="btn-game"
                style="font-size: 4rem; padding: 30px 80px; background: #00e676; color: black; border-color: #00e676; box-shadow: 0 0 50px #00e676;"
                onclick="startMatchNow()">
                BA≈ûLA! ü•ä
            </button>
        </div>
    </div>

    <!-- MOVED ABOUT MODAL OUTSIDE GAME CONTAINER -->
    <div id="about-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 3000; backdrop-filter: blur(5px); overflow-y: auto;">
        <div
            style="max-width: 800px; margin: 50px auto; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; padding: 40px; border-radius: 12px; box-shadow: 0 0 50px rgba(0, 229, 255, 0.1); position: relative;">
            <button id="btn-close-about"
                style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #666; font-size: 24px; cursor: pointer;"
                onclick="document.getElementById('about-modal').style.display='none'; if(typeof GAME!=='undefined') GAME.paused=false;">‚úï</button>
            <h1
                style="color: #00e5ff; margin-bottom: 30px; text-align: center; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                Vision Fighter - OYUN REHBERƒ∞
            </h1>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <!-- LEFT COLUMN: CONTROLS -->
                <div>
                    <h3 style="color: gold; display: flex; align-items: center; gap: 10px;">
                        ü•ä KONTROLLER
                    </h3>
                    <p style="color: #bbb; font-size: 0.9rem;">Kamera kar≈üƒ±sƒ±na ge√ßin. Elleriniz boks eldiveni
                        gibidir.</p>

                    <div
                        style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong style="color: #ff4081;">YUMRUK ATMA</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ddd;">
                            <li><strong>Direk Vuru≈ü:</strong> Elinizi kameraya doƒüru uzatƒ±n (Yumruk atar gibi).</li>
                            <li><strong>Aparkat:</strong> Elinizi a≈üaƒüƒ±dan yukarƒ±ya hƒ±zlƒ±ca kaldƒ±rƒ±n.</li>
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <strong style="color: #00e676;">SAVUNMA & HAREKET</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ddd;">
                            <li><strong>Gard Al:</strong> ƒ∞ki elinizi y√ºz hizanƒ±za kaldƒ±rƒ±n (Y√ºz√ºn√º koru!).</li>
                            <li><strong>Ka√ßƒ±≈ü (Dodge):</strong> V√ºcudunuzu saƒüa veya sola eƒüin (Kamerada ellerinizi
                                o y√∂ne g√∂t√ºr√ºn).</li>
                        </ul>
                    </div>
                </div>

                <!-- RIGHT COLUMN: MECHANICS -->
                <div>
                    <h3 style="color: cyan; display: flex; align-items: center; gap: 10px;">
                        ‚ö° OYUN MEKANƒ∞KLERƒ∞
                    </h3>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: gold;">üü° STAMINA (ENERJƒ∞)</strong>
                        <p style="color: #ccc; font-size: 0.9rem;">Her yumruk enerji harcar. Enerjin biterse
                            yorulursun ve vuru≈ü yapamazsƒ±n! Bekleyerek veya gard alarak enerjini topla.</p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #00e5ff;">üîµ S√úPER G√ú√á (ULTIMATE)</strong>
                        <p style="color: #ccc; font-size: 0.9rem;">Rakibe vurduk√ßa mavi bar dolar. Dolduƒüunda
                            <strong>ƒ∞Kƒ∞ ELƒ∞Nƒ∞ HAVAYA KALDIR</strong> ve rakibi yok et!
                        </p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #ff1744;">‚ù§Ô∏è CAN YENƒ∞LEME</strong>
                        <p style="color: #ccc; font-size: 0.9rem;">Bir s√ºre hasar almazsan canƒ±n yava≈ü√ßa yenilenir.
                            Stratejik oyna!</p>
                    </div>
                </div>
            </div>

            <div
                style="margin-top: 30px; padding: 20px; background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent); border-left: 4px solid gold; border-radius: 4px;">
                <h4 style="margin: 0 0 5px 0; color: gold;">üí° ƒ∞PU√áLARI</h4>
                <p style="margin: 0; color: #ddd; font-style: italic;">
                    "Sadece saldƒ±rmak yetmez. Rakibini izle, o saldƒ±rdƒ±ƒüƒ±nda gard al veya ka√ß, bo≈üa d√º≈üt√ºƒü√ºnde
                    cezalandƒ±r!"
                </p>
            </div>
        </div>
    </div>

    <script>
        window.onerror = (msg, url, line) => { const e = document.getElementById('error-box'); e.style.display = 'block'; e.innerText = `HATA: ${msg} @ ${line}`; };

        // --- ASSET LOADING ---
        const SPRITES_P = {
            idle: new Image(), guard: new Image(), punchL: new Image(), punchR: new Image(), ko: new Image()
        };
        SPRITES_P.idle.src = 'krmz-durus.png';
        SPRITES_P.guard.src = 'krmz-gard.png';
        SPRITES_P.punchL.src = 'krmz-sol.png';
        SPRITES_P.punchR.src = 'krmz-sag.png';
        SPRITES_P.ko.src = 'krmz-nakavt.png';

        const SPRITES_E = {
            idle: new Image(), guard: new Image(), punchL: new Image(), punchR: new Image(), ko: new Image()
        };
        SPRITES_E.idle.src = 'mavi-durus.png';
        SPRITES_E.guard.src = 'mavi-gard.png';
        SPRITES_E.punchL.src = 'mavi-sol.png';
        SPRITES_E.punchR.src = 'mavi-sag.png';
        SPRITES_E.ko.src = 'mavi-nakavt.png';

        // NEW: TRAINING DUMMY SPRITES
        const SPRITES_TRAINING = {
            idle: new Image(), left: new Image(), right: new Image(), ko: new Image()
        };
        SPRITES_TRAINING.idle.src = 'kt.png';
        SPRITES_TRAINING.left.src = 'kt.sol.png';
        SPRITES_TRAINING.right.src = 'kt.sag.png';
        SPRITES_TRAINING.ko.src = 'kt.png'; // No KO for bag really, but fallback

        const LEVELS_NORMAL = [
            { name: "ACEMƒ∞", hp: 100, dmg: 5, aggro: 0.015, speed: 1.0, color: '#8d6e63' },
            { name: "ORTA", hp: 120, dmg: 8, aggro: 0.04, speed: 1.2, color: '#ffb74d' },
            { name: "UZMAN", hp: 150, dmg: 12, aggro: 0.08, speed: 1.5, color: '#ff1744' },
            { name: "PROFES√ñR", hp: 200, dmg: 15, aggro: 0.12, speed: 1.8, color: '#d500f9' },
            { name: "ORDINARY√úS", hp: 300, dmg: 20, aggro: 0.20, speed: 2.2, color: '#ffd700' }
        ];

        const LEVELS_WORLD_CLASS = [
            { name: "GURU", hp: 350, dmg: 12, aggro: 0.35, speed: 1.5, color: '#00bcd4' },
            { name: "√úSTAD", hp: 450, dmg: 18, aggro: 0.45, speed: 1.8, color: '#76ff03' },
            { name: "EFSANE", hp: 600, dmg: 25, aggro: 0.55, speed: 2.3, color: '#ff6d00' },
            { name: "WORLD CHAMPION", hp: 800, dmg: 35, aggro: 0.65, speed: 3.0, color: '#d50000' }
        ];

        let CURRENT_LEVELS = LEVELS_NORMAL;


        const CANVAS = document.querySelector('.output_canvas');
        const CTX = CANVAS.getContext('2d');
        const VIDEO = document.querySelector('.input_video');
        const AUDIO_CTX = new (window.AudioContext || window.webkitAudioContext)();

        window.addEventListener('resize', () => {
            GAME.width = window.innerWidth;
            GAME.height = window.innerHeight;
            CANVAS.width = GAME.width;
            CANVAS.height = GAME.height;
            GAME.groundY = GAME.height * 0.75;
        });

        // --- MODAL LOGIC ---
        const btnAbout = document.getElementById('btn-about');
        const modalAbout = document.getElementById('about-modal');
        const btnCloseAbout = document.getElementById('btn-close-about');

        if (btnAbout && modalAbout && btnCloseAbout) {
            btnAbout.addEventListener('click', () => {
                modalAbout.style.display = 'block';
                if (typeof GAME !== 'undefined') GAME.paused = true;
            });

            btnCloseAbout.addEventListener('click', () => {
                modalAbout.style.display = 'none';
                if (typeof GAME !== 'undefined') GAME.paused = false;
            });

            // Close on outside click
            modalAbout.addEventListener('click', (e) => {
                if (e.target === modalAbout) {
                    modalAbout.style.display = 'none';
                    if (typeof GAME !== 'undefined') GAME.paused = false;
                }
            });
        }

        const GAME = {
            active: false,
            paused: false,
            waitingForStart: false, // New Flag
            mode: 'NORMAL',
            levelIdx: 0,
            round: 1, // Initialize Round
            playerName: "OYUNCU",
            width: 1280, height: 720, groundY: 600,
            player: null, enemy: null,
            particles: [], shake: 0,
            lastDamageTime: 0,
            handsInitialized: false,
            hands: { L: { x: 0, y: 0, prev: { x: 0, y: 0 } }, R: { x: 0, y: 0, prev: { x: 0, y: 0 } } }
        };

        class Fighter {
            constructor(x, color, facing, stats, isCPU = false, sprites = null) {
                // ... (Existing props)
                this.x = x; this.y = GAME.groundY;
                this.vx = 0; this.vy = 0;
                this.maxHp = stats.hp || 100;
                this.hp = this.maxHp;
                this.dmg = stats.dmg || 10;
                this.aggro = stats.aggro || 0.02;
                this.speed = stats.speed || 1.0;
                this.facing = facing;
                this.color = color;
                this.sprites = sprites;
                this.state = 'IDLE';
                this.timer = 0;
                this.cooldown = 0;
                this.isCPU = isCPU;
                this.hasHiTarget = false;
                this.guardTimer = 0;

                // NEW: Gameplay Depth
                this.stamina = 100; this.maxStamina = 100;
                this.superMeter = 0; this.maxSuper = 100;
                this.combo = 0; this.comboTimer = 0;

                // Special for Sandbag
                this.isSandbag = (sprites === SPRITES_TRAINING);
                this.swayTimer = 0;
            }

            update() {
                // ... (Existing movement)
                this.x += this.vx;
                this.vx *= 0.8;
                if (this.x < 120) this.x = 120;
                if (this.x > GAME.width - 120) this.x = GAME.width - 120;

                if (this.cooldown > 0) this.cooldown--;
                if (this.guardTimer > 0) { this.guardTimer--; if (this.guardTimer === 0 && this.state === 'GUARD') this.state = 'IDLE'; }

                if (this.state === 'HIT' && this.cooldown === 0) this.state = 'IDLE';
                if ((this.state.startsWith('PUNCH') || this.state.startsWith('UPPERCUT')) && this.cooldown === 0) {
                    this.state = 'IDLE';
                    this.hasHiTarget = false;
                }

                // Stamina Regen
                if (this.state === 'IDLE' && this.stamina < this.maxStamina) this.stamina += 0.5;

                // Combo Timer
                if (this.comboTimer > 0) {
                    this.comboTimer--;
                    if (this.comboTimer === 0) this.combo = 0; // Combo Reset
                }

                // Regen Logic (Existing)
                const canRegen = !this.isCPU || (this.isCPU && GAME.levelIdx === 4);
                const timeSinceCombat = Date.now() - GAME.lastDamageTime;
                if (this.state === 'IDLE' && this.hp < this.maxHp && this.hp > 0 && timeSinceCombat > 2500) {
                    if (canRegen) {
                        this.hp += 0.2;
                        if (this.hp > this.maxHp) this.hp = this.maxHp;
                        if (!this.isCPU) document.getElementById('regen-indicator').style.opacity = 0.8;
                    }
                } else {
                    if (!this.isCPU) document.getElementById('regen-indicator').style.opacity = 0;
                }

                this.timer++;
                if (this.swayTimer > 0) this.swayTimer--;
            }

            punch(hand, type = 'NORMAL') {
                if (this.state === 'KO' || this.state === 'HIT' || this.state === 'GUARD') return;

                // Stamina Check
                if (this.stamina < 15) {
                    if (!this.isCPU) spawnPop(this.x, this.y - 50, "TIRED!", "gray");
                    return;
                }

                this.state = (type === 'UPPER') ? `UPPERCUT_${hand}` : `PUNCH_${hand}`;
                this.cooldown = Math.max(5, 12 - (this.speed * 2));
                this.vx = (type === 'UPPER') ? 5 * this.facing : 15 * this.facing;
                this.hasHiTarget = false;
                this.stamina -= 15; // Consume Stamina
                playSfx('swish');
            }



            setGuard(active) {
                if (this.isSandbag) return; // Sandbag cannot guard
                if (this.state === 'KO' || this.state === 'HIT' || this.state.startsWith('PUNCH')) return;
                if (active) { this.state = 'GUARD'; }
                else if (this.state === 'GUARD') this.state = 'IDLE';
            }

            hit(dmg, srcX) {
                if (this.state === 'KO') return;

                // GUARD: Reduce damage by 70% (Take 30%), play block sound.
                if (this.state === 'GUARD') {
                    playSfx('block');
                    this.hp -= dmg * 0.3; // Chip damage
                    GAME.lastDamageTime = Date.now();
                    this.vx = Math.sign(this.x - srcX) * 10; // Reduced pushback
                    spawnParticles(this.x, this.y - 120, 5, "#fff"); // Sparks
                    if (this.hp <= 0) { this.hp = 0; this.state = 'KO'; endGame(this !== GAME.player); }
                    return;
                }

                if (this.state === 'HIT' && !this.isSandbag) return; // Sandbag can be hit repeatedly for effect

                // Successful Hit Logic
                // Identify Attacker (Reverse of 'this') - Assuming GAME.player/GAME.enemy global access
                const attacker = (this === GAME.player) ? GAME.enemy : GAME.player;
                attacker.combo++;
                attacker.comboTimer = 60; // 1 second window
                attacker.superMeter = Math.min(attacker.maxSuper, attacker.superMeter + 10);
                if (attacker.combo > 1) spawnPop(this.x, this.y - 200, `${attacker.combo}x COMBO!`, "gold");

                this.hp -= dmg;
                GAME.lastDamageTime = Date.now();
                this.state = 'HIT';
                this.cooldown = 30; // Stun time

                // NO MOVEMENT FOR SANDBAG
                if (!this.isSandbag) {
                    this.vx = Math.sign(this.x - srcX) * 25;
                    if (this.vx === 0) this.vx = this.facing * -25;
                } else {
                    this.vx = 0;
                }

                GAME.shake = 15;
                playSfx('hit');
                spawnParticles(this.x, this.y - 120, 15, this.color);
                spawnPop(this.x, this.y - 150, "POW!", "#fff");

                // Sandbag doesn't die easily in training
                if (this.hp <= 0) {
                    this.hp = 0; this.state = 'KO';
                    endGame(this !== GAME.player);
                }

                // TRIGGER SWAY FOR SANDBAG
                if (this.isSandbag) {
                    this.swayTimer = 30; // 0.5s approx (at 60fps)
                }
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(this.facing, 1);

                // Shadow
                ctx.shadowBlur = 20; ctx.shadowColor = this.color;

                const bob = (this.state === 'IDLE') ? Math.sin(this.timer * 0.1) * 5 : 0;
                ctx.translate(0, bob);

                if (this.state === 'HIT') {
                    ctx.rotate((Math.random() - 0.5) * 0.3);
                }

                // Determine Sprite based on State
                let currentImg = this.sprites ? this.sprites.idle : null;

                if (this.sprites) {
                    if (this.isSandbag) {
                        // SANDBAG ANIMATION: Left -> idle -> Right -> idle
                        // SwayTimer: 30..20 (Left), 20..10 (Idle), 10..0 (Right) - Simplified
                        // Request: kt.sol (Left) -> kt (Idle) -> kt.sag (Right) -> kt (Idle)
                        if (this.swayTimer > 20) currentImg = this.sprites.left;
                        else if (this.swayTimer > 10) currentImg = this.sprites.idle;
                        else if (this.swayTimer > 0) currentImg = this.sprites.right;
                        else currentImg = this.sprites.idle;
                    } else {
                        if (this.state === 'KO') currentImg = this.sprites.ko;
                        else if (this.state === 'GUARD') currentImg = this.sprites.guard;
                        else if (this.state.includes('PUNCH_L') || this.state.includes('UPPERCUT_L')) currentImg = this.sprites.punchL;
                        else if (this.state.includes('PUNCH_R') || this.state.includes('UPPERCUT_R')) currentImg = this.sprites.punchR;
                    }
                }

                // DRAW SPRITE
                if (currentImg && currentImg.complete && currentImg.naturalWidth > 0) {
                    ctx.save();
                    if (this.isCPU) { ctx.scale(-1, 1); }

                    let w = 240;
                    let h = 320;
                    let yOffset = -h + 40;

                    if (this.state === 'KO') {
                        // Adjusted size/pos for knockout image
                        w = 300;
                        h = 300;
                        yOffset = -h + 100; // Lower to ground
                    }

                    // Position Correction: Raised by 20px (-h + 40)
                    ctx.drawImage(currentImg, -w / 2, yOffset, w, h);
                    ctx.restore();
                } else {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-40, -200, 80, 200);
                }

                ctx.restore();
            }
        }

        // --- FLOW CONTROL ---
        function startGameFlow(mode = 'NORMAL') {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) { alert("L√ºtfen bir isim girin!"); return; }
            GAME.playerName = name;
            GAME.levelIdx = 0;
            GAME.mode = mode; // Store mode

            // CONFIG BASED ON MODE
            let enemyStats = { hp: 100, dmg: 5, aggro: 0.01, speed: 0.8, name: "ANTRENMAN KUKLASI", color: "#888" };

            if (mode === 'TRAINING') {
                GAME.totalRounds = 999; // Infinite
                GAME.roundTime = 9999; // Infinite Time
                enemyStats = { hp: 10000, dmg: 0, aggro: 0, speed: 0, name: "KUM TORBASI", color: "#888" };
                CURRENT_LEVELS = [{ name: "KUM TORBASI", color: "#888", hp: 10000, dmg: 0, aggro: 0, speed: 0 }]; // Dummy level for training
            } else if (mode === 'WORLD_CLASS') {
                CURRENT_LEVELS = LEVELS_WORLD_CLASS;
                GAME.totalRounds = 3;
                GAME.roundTime = 60; // Standard 60s
            } else {
                CURRENT_LEVELS = LEVELS_NORMAL;
                GAME.totalRounds = 3;
                GAME.roundTime = 60; // Standard 60s
            }

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('hud-p-name').innerText = name;
            document.getElementById('cert-player-name').innerText = name;

            startLevel();
        }

        async function startLevel() {
            const lvl = (GAME.mode === 'TRAINING') ? CURRENT_LEVELS[0] : CURRENT_LEVELS[GAME.levelIdx];
            document.getElementById('message-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('level-indicator').innerText = lvl.name;
            document.getElementById('hud-e-name').innerText = lvl.name;
            document.getElementById('hud-e-name').style.color = lvl.color;

            GAME.width = window.innerWidth; GAME.height = window.innerHeight;
            CANVAS.width = GAME.width; CANVAS.height = GAME.height;
            GAME.groundY = GAME.height * 0.75;

            // Player on Right (0.8), facing Left (-1)
            GAME.player = new Fighter(GAME.width * 0.8, '#d50000', -1, { hp: 100, dmg: 10 }, false, SPRITES_P); // Player Red

            // Enemy
            let enemySprites = SPRITES_E;
            let enemyX = GAME.width * 0.2; // Default starting X

            if (GAME.mode === 'TRAINING') {
                enemySprites = SPRITES_TRAINING;
                enemyX = GAME.width * 0.6; // Closer to player (who is at 0.8)
            }

            // Enemy on Left, facing Right (1)
            GAME.enemy = new Fighter(enemyX, lvl.color, 1, lvl, true, enemySprites);

            GAME.lastDamageTime = Date.now();
            GAME.active = true;

            if (AUDIO_CTX.state === 'suspended') AUDIO_CTX.resume();

            // Start Music
            if (typeof SOUNDS !== 'undefined' && SOUNDS.bgMusic) {
                SOUNDS.bgMusic.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
            }

            // START LOOP IMMEDIATELY (Don't wait for camera)
            if (!GAME.active) { GAME.active = true; }

            // SHOW START OVERLAY WITH DELAY
            GAME.waitingForStart = true;
            document.getElementById('start-overlay').style.display = 'none'; // Hidden initially
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'flex';
            }, 3000); // 3 Seconds Delay

            loop();

            // Initialize Tracking in Background
            if (!GAME.handsInitialized) {
                GAME.handsInitialized = true; // Mark as trying to init
                initTracking().then(() => {
                    console.log("Tracking Initialized");
                }).catch(e => {
                    console.error("Tracking Failed:", e);
                    alert("Kamera hatasƒ±: " + e.message);
                });
            }
        }

        function loop() {
            requestAnimationFrame(loop);
            if (!GAME.active) return;
            try {
                // UPDATE LOGIC - Only if not waiting
                if (!GAME.waitingForStart && !GAME.paused) {
                    GAME.player.update();
                    updateAI();

                    // --- ROUND LOGIC ---
                    if (!GAME.isResting && !GAME.fightOver) {
                        // Decrease Timer
                        if (!GAME.lastTime) GAME.lastTime = Date.now();
                        const now = Date.now();
                        if (now - GAME.lastTime >= 1000) {
                            GAME.roundTime--;
                            GAME.lastTime = now;
                            if (GAME.roundTime <= 0) {
                                endRound();
                            }
                        }
                        // Update UI
                        document.getElementById('timer-disp').innerText = GAME.roundTime;
                        document.getElementById('round-disp').innerText = "RAUND " + GAME.round;
                    }

                    // NO CROSSING PHYSICS (Updated for P Right, E Left)
                    // Enemy must be Left of Player (E.x < P.x)
                    // If E gets too close to P's left side (E.x > P.x - separation) -> Push apart
                    const separation = 100;
                    if (GAME.enemy.x > GAME.player.x - separation) {
                        const mid = (GAME.player.x + GAME.enemy.x) / 2;
                        GAME.enemy.x = mid - separation / 2;
                        GAME.player.x = mid + separation / 2;
                        if (GAME.player.vx < 0) GAME.player.vx = 0;
                        if (GAME.enemy.vx > 0) GAME.enemy.vx = 0;
                    }

                    updateParticles();
                    if (typeof updateVFX === 'function') updateVFX(); // Add VFX Update
                    checkCollisions();

                    // Update New Bars
                    document.getElementById('p-hp').style.width = Math.max(0, (GAME.player.hp / GAME.player.maxHp * 100)) + '%';
                    document.getElementById('e-hp').style.width = Math.max(0, (GAME.enemy.hp / GAME.enemy.maxHp * 100)) + '%';
                    document.getElementById('p-stamina').style.width = GAME.player.stamina + '%';
                    document.getElementById('p-super').style.width = GAME.player.superMeter + '%';

                    if (GAME.player.superMeter >= 100) {
                        document.getElementById('super-text').style.opacity = (Math.floor(Date.now() / 200) % 2); // Blink
                    } else {
                        document.getElementById('super-text').style.opacity = 0;
                    }
                } // End if !waitingForStart

                CTX.save();
                if (GAME.shake > 0) { CTX.translate((Math.random() - 0.5) * GAME.shake, (Math.random() - 0.5) * GAME.shake); GAME.shake *= 0.9; if (GAME.shake < 1) GAME.shake = 0; }
                CTX.clearRect(0, 0, GAME.width, GAME.height);

                // Draw Ground Line - Bright and Visible
                CTX.strokeStyle = '#eee'; CTX.lineWidth = 4; // Bold White
                CTX.beginPath(); CTX.moveTo(0, GAME.groundY); CTX.lineTo(GAME.width, GAME.groundY); CTX.stroke();

                GAME.player.draw(CTX);
                GAME.enemy.draw(CTX);
                drawParticles(CTX);
                if (typeof drawVFX === 'function') drawVFX(CTX); // Add VFX Draw

                CTX.restore();
            } catch (e) {
                console.error(e);
            }
        }

        async function initTracking() {
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(handleInput);

            const cam = new Camera(VIDEO, {
                onFrame: async () => { await hands.send({ image: VIDEO }); },
                width: 640, height: 360
            });
            await cam.start();
        }

        function startMatchNow() {
            GAME.waitingForStart = false;
            document.getElementById('start-overlay').style.display = 'none';
            GAME.lastTime = Date.now(); // Reset timer to avoid instant count down
            playSfx('fight'); // Fight sound
        }

        function nextLevel() {
            GAME.levelIdx++;
            if (GAME.levelIdx >= CURRENT_LEVELS.length) {
                showChampionScreen();
            } else {
                startLevel();
            }
        }

        function showChampionScreen() {
            document.getElementById('message-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('champion-screen').style.display = 'flex';
            document.getElementById('certificate').style.display = 'block';

            if (GAME.mode === 'WORLD_CLASS') {
                document.getElementById('cert-rank').innerText = "D√úNYA EFSANESƒ∞";
                document.getElementById('cert-title').innerText = "EVRENƒ∞N HAKƒ∞Mƒ∞ ü™ê";
                document.getElementById('cert-title').style.color = "#d50000";
            } else {
                document.getElementById('cert-rank').innerText = "ORDINARY√úS";
                document.getElementById('cert-title').innerText = "D√úNYA ≈ûAMPƒ∞YONU";
            }

            playSfx('win'); playSfx('win'); playSfx('win');
        }

        function endGame(win) {
            GAME.active = false;
            setTimeout(() => {
                if (win) {
                    if (GAME.levelIdx === CURRENT_LEVELS.length - 1) {
                        showChampionScreen();
                    } else {
                        const msg = document.getElementById('message-screen');
                        msg.style.display = 'flex';
                        document.querySelector('#message-screen h1').innerText = "KAZANDIN! üèÜ";
                        document.querySelector('#message-screen h1').style.color = "#00e676";
                        document.querySelector('#message-screen h3').innerText = `${CURRENT_LEVELS[GAME.levelIdx + 1].name} SENƒ∞ BEKLƒ∞YOR...`;
                        document.getElementById('msg-btn').innerText = "SIRADAKƒ∞ SEVƒ∞YE >>";
                        document.getElementById('msg-btn').onclick = nextLevel;
                    }
                } else {
                    const msg = document.getElementById('message-screen');
                    msg.style.display = 'flex';
                    document.querySelector('#message-screen h1').innerText = "KAYBETTƒ∞N üíÄ";
                    document.querySelector('#message-screen h1').style.color = "#ff1744";
                    document.querySelector('#message-screen h3').innerText = "PES ETMEK YOK!";
                    document.getElementById('msg-btn').innerText = "TEKRAR DENE ü•ä";
                    document.getElementById('msg-btn').onclick = () => startLevel();
                }
            }, 1500);
        }

        // --- PARTICLE SYSTEM ---
        function spawnParticles(x, y, color) {
            for (let i = 0; i < 5; i++) {
                GAME.particles.push({
                    x, y, color,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0
                });
            }
        }

        function updateParticles() {
            for (let i = GAME.particles.length - 1; i >= 0; i--) {
                let p = GAME.particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) GAME.particles.splice(i, 1);
            }
        }

        function drawParticles(ctx) {
            GAME.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        function endRound() {
            if (GAME.round >= GAME.totalRounds) {
                endFight();
                return;
            }

            GAME.isResting = true;
            document.getElementById('game-status-text').innerText = "RAUND ARASI - Dƒ∞NLEN! (+20 HP)";
            // Heal
            GAME.player.hp = Math.min(GAME.player.hp + 20, GAME.player.maxHp);
            GAME.enemy.hp = Math.min(GAME.enemy.hp + 20, GAME.enemy.maxHp);

            playSfx('win'); // Bell sound placeholder

            let restTime = 10;
            const restInterval = setInterval(() => {
                document.getElementById('timer-disp').innerText = "Dƒ∞NLEN: " + restTime;
                restTime--;
                if (restTime < 0) {
                    clearInterval(restInterval);
                    startNextRound();
                }
            }, 1000);
        }

        function startNextRound() {
            GAME.round++;
            GAME.roundTime = 60;
            GAME.isResting = false;
            GAME.player.x = GAME.width * 0.8; // Reset Pos
            GAME.enemy.x = GAME.width * 0.2;
            document.getElementById('game-status-text').innerText = "D√ñV√ú≈û!";
            playSfx('fight');
        }

        function endFight() {
            GAME.fightOver = true;
            let result = "BERABERE";
            if (GAME.player.hp > GAME.enemy.hp) result = "KAZANDIN! üèÜ";
            else if (GAME.enemy.hp > GAME.player.hp) result = "KAYBETTƒ∞N! üíÄ";

            alert("MA√á Bƒ∞TTƒ∞: " + result);
            location.reload(); // Simple reset for now
        }

        function updateAI() {
            const E = GAME.enemy; const P = GAME.player;
            if (E.state === 'KO' || E.state === 'HIT') { E.update(); return; }

            // TRAINING MODE: Passive Sandbag
            if (GAME.mode === 'TRAINING') {
                E.update();
                // Optional: Random guard to practice guard breaking?
                // For now, completely passive.
                return;
            }

            E.timer++; const dist = Math.abs(P.x - E.x);

            if ((P.state.startsWith('PUNCH') || P.state.startsWith('UPPERCUT')) && dist < 350 && E.state !== 'GUARD') {
                const guardChance = GAME.levelIdx * 0.12 + 0.1;
                if (Math.random() < guardChance) { E.setGuard(true); E.guardTimer = 40; }
            }
            if (E.state !== 'GUARD' && E.guardTimer === 0) {
                // Enemy Logic (Left Side)
                // Move towards Player (Right) -> vx should be positive (matching facing 1)
                // Retreat -> vx should be negative
                if (dist > 250) E.vx += 1.5 * E.speed; else if (dist < 150) E.vx -= 1.5 * E.speed;
                if (dist < 320 && E.cooldown === 0 && Math.random() < E.aggro) {
                    const rnd = Math.random();
                    if (rnd < 0.3) E.punch('R', 'UPPER'); else E.punch(rnd < 0.6 ? 'L' : 'R');
                }
            }
            E.update();
        }

        function checkCollisions() {
            const P = GAME.player; const E = GAME.enemy;
            const dist = Math.abs(P.x - E.x);
            const reach = 320;
            if ((P.state.startsWith('PUNCH') || P.state.startsWith('UPPERCUT')) && !P.hasHiTarget && dist < reach) { E.hit(P.dmg, P.x); P.hasHiTarget = true; }
            if ((E.state.startsWith('PUNCH') || E.state.startsWith('UPPERCUT')) && !E.hasHiTarget && dist < reach) { P.hit(E.dmg, E.x); E.hasHiTarget = true; }
        }

        function handleInput(results) {
            if (!GAME.active || !results.multiHandLandmarks) return;
            try {
                let realLeft = null; let realRight = null;
                if (results.multiHandedness) {
                    for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                        const label = results.multiHandedness[i].label;
                        const wrist = results.multiHandLandmarks[i][0];
                        if (label === 'Left') realLeft = wrist; if (label === 'Right') realRight = wrist;
                    }
                }

                const status = document.getElementById('game-status-text');
                status.innerText = "";
                let guarding = false;

                if (realLeft && realRight) {
                    const dx = realLeft.x - realRight.x; const dy = realLeft.y - realRight.y; const dist = Math.hypot(dx, dy);
                    // Guard Logic: Hands high (y < 0.6) and relatively close (dist < 0.5)
                    // Added: Check if hands are close to head height
                    if (realLeft.y < 0.6 && realRight.y < 0.6 && dist < 0.5) {
                        guarding = true; status.innerText = "GARD üõ°Ô∏è";
                        document.body.style.border = "10px solid gold"; // Visual indicator
                    } else {
                        document.body.style.border = "none";

                        // SUPER MOVE: Both hands very high (y < 0.2) and meter full
                        if (GAME.player.superMeter >= 99 && realLeft.y < 0.2 && realRight.y < 0.2) {
                            GAME.player.superMeter = 0;
                            // Execute Super - Instant damage to enemy
                            spawnPop(GAME.enemy.x, GAME.enemy.y - 200, "SUPER HIT!!!", "cyan");
                            GAME.enemy.hit(40, GAME.player.x); // Massive Damage
                            playSfx('hit'); playSfx('hit'); // Loud
                            GAME.shake = 30;
                            status.innerText = "SUPER HAREKET!!!";
                        }

                        // Input Logic
                        // Player on Right (facing Left, -1). 
                        // Forward (Advance towards Enemy on Left): Move Left (-x).
                        // Escape (Retreat to Right): Move Right (+x).

                        // "Forward" Gesture (Left Hand > Right Hand? No, standard logic usually)
                        // Original: if (realLeft.x > realRight.x) -> Approach
                        if (realLeft.x > realRight.x) { GAME.player.vx -= 4; status.innerText = "ƒ∞LERƒ∞ >>"; } // Move Left
                        else if (dist < 0.3) { GAME.player.vx += 15; status.innerText = "<< KA√á!"; } // Move Right
                    }
                }
                GAME.player.setGuard(guarding);
                if (!guarding) {
                    if (realLeft) checkVel('L', realLeft);
                    if (realRight) checkVel('R', realRight);
                }
            } catch (e) { }
        }

        function checkVel(side, wrist) {
            const h = GAME.hands[side];
            const vx = (wrist.x - h.prev.x) * GAME.width;
            const vy = (wrist.y - h.prev.y) * GAME.height;
            const spd = Math.hypot(vx, vy);
            h.prev.x = wrist.x; h.prev.y = wrist.y;
            if (spd > 45) {
                if (vy < -20 && Math.abs(vy) > Math.abs(vx)) GAME.player.punch(side, 'UPPER');
                else GAME.player.punch(side, 'NORMAL');
            }
        }

        // --- PARTICLE SYSTEM ---
        function spawnParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                GAME.particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: color
                });
            }
        }

        function updateParticles() {
            for (let i = GAME.particles.length - 1; i >= 0; i--) {
                let p = GAME.particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) GAME.particles.splice(i, 1);
            }
        }

        function drawParticles(ctx) {
            GAME.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // --- VFX SYSTEM ---
        const VFX = {
            pops: [],
            vignetteOpacity: 0
        };

        function spawnPop(x, y, text, color) {
            VFX.pops.push({ x, y, text, color, life: 1.0, vy: -2 });
        }

        function updateVFX() {
            // Update Pops
            for (let i = VFX.pops.length - 1; i >= 0; i--) {
                let p = VFX.pops[i]; p.y += p.vy; p.life -= 0.05;
                if (p.life <= 0) VFX.pops.splice(i, 1);
            }
            // Update Vignette (Low Health Red Overlay)
            let targetOpacity = 0;
            if (GAME.player.hp < GAME.player.maxHp * 0.3) {
                targetOpacity = 1 - (GAME.player.hp / (GAME.player.maxHp * 0.3)); // 0 to 1
            }
            VFX.vignetteOpacity += (targetOpacity - VFX.vignetteOpacity) * 0.1;
        }

        function drawVFX(ctx) {
            // Draw Vignette
            if (VFX.vignetteOpacity > 0.01) {
                const grad = ctx.createRadialGradient(GAME.width / 2, GAME.height / 2, GAME.height / 3, GAME.width / 2, GAME.height / 2, GAME.height);
                grad.addColorStop(0, "rgba(255, 0, 0, 0)");
                grad.addColorStop(1, `rgba(255, 0, 0, ${VFX.vignetteOpacity * 0.6})`);
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, GAME.width, GAME.height);
            }
            // Draw Pops
            ctx.font = "bold 40px Impact";
            ctx.textAlign = "center";
            VFX.pops.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = "white"; ctx.strokeStyle = "black"; ctx.lineWidth = 2;
                ctx.fillText(p.text, p.x, p.y);
                ctx.strokeText(p.text, p.x, p.y);
            });
            ctx.globalAlpha = 1;
        }

        const SOUNDS = {
            bgMusic: new Audio('https://opengameart.org/sites/default/files/action_music.mp3'), // Placeholder URL
            crowd: new Audio('https://opengameart.org/sites/default/files/crowd_cheer.wav'), // Placeholder URL
            fight: new Audio('https://opengameart.org/sites/default/files/fight.wav'), // Placeholder URL
            ko: new Audio('https://opengameart.org/sites/default/files/ko.wav') // Placeholder URL
        };
        SOUNDS.bgMusic.loop = true;
        SOUNDS.bgMusic.volume = 0.4;

        function playSfx(type) {
            if (!AUDIO_CTX) return;
            const t = AUDIO_CTX.currentTime; const o = AUDIO_CTX.createOscillator(); const g = AUDIO_CTX.createGain(); o.connect(g); g.connect(AUDIO_CTX.destination);

            if (type === 'hit') {
                // Enhanced Hit Sound
                o.type = 'sawtooth'; o.frequency.exponentialRampToValueAtTime(10, t + 0.2);
                g.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                o.start(t); o.stop(t + 0.2);
                // Trigger Crowd on good hits
                if (Math.random() < 0.3) {
                    // Simple crowd swell logic could go here
                }
            }
            else if (type === 'block') { o.type = 'square'; o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(50, t + 0.1); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.1); o.start(t); o.stop(t + 0.1); }
            else if (type === 'win') { o.type = 'triangle'; o.frequency.setValueAtTime(440, t); o.frequency.setValueAtTime(554, t + 0.1); o.frequency.setValueAtTime(659, t + 0.2); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.5); o.start(t); o.stop(t + 0.5); }
            else { const n = AUDIO_CTX.createBufferSource(); const b = AUDIO_CTX.createBuffer(1, AUDIO_CTX.sampleRate * 0.1, AUDIO_CTX.sampleRate); const d = b.getChannelData(0); for (let i = 0; i < d.length; i++)d[i] = Math.random() * 2 - 1; n.buffer = b; const f = AUDIO_CTX.createBiquadFilter(); f.frequency.value = 600; n.connect(f); f.connect(g); g.gain.linearRampToValueAtTime(0, t + 0.1); n.start(t); }
        }


    </script>
</body>

</html>